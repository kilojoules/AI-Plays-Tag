# Trajectory Rendering Guide

This workflow converts a captured episode (`trajectory.jsonl`) into a replay video.

## Prerequisites
- Godot 4 binary available (set `GODOT_BIN` if not found automatically).
- A trajectory file, typically generated by running headless training with `AI_LOG_TRAJECTORIES=1`.
- If you have older runs stored in Godot's `app_userdata`, run `pixi run migrate-user-data` once to import them into `data/trajectories`.

## Steps
1. Point the script at the trajectory (defaults to the most recent file under `data/trajectories`):
   ```bash
   GODOT_BIN=/path/to/Godot \
   AI_REPLAY_PATH="data/trajectories/ep_00042.jsonl" \
   ./scripts/render_trajectory.sh high
   ```
   - Use `low` for faster preview renders.
2. The script launches `Replay.tscn` with recording enabled, then calls `scripts/encode_frames.sh` to produce an MP4 in the project root.
3. Raw frames remain in `data/frames`. The encoder overwrites any existing `learn_progress-<timestamp>.mp4` unless you move/rename it.

## Output Checklist
- `frames/frame_XXXXX.png` sequence for each captured frame (60 FPS by default).
- `learn_progress-<timestamp>.mp4` or `out.mp4` assembled via FFmpeg.
- Optional debug bundle: use `scripts/collect_debug_artifacts.sh` to save the MP4, trajectory, and metadata together.

## Plotting Path Maps

When you have saved policies for both roles (`trainer/policy_seeker.pt` and `trainer/policy_hider.pt`), you can generate a top-down PNG of the paths taken during a single evaluation episode.

1. Run a headless evaluation episode and render the plot (creates a debug bundle under `debug/<timestamp>_eval/`):
   ```bash
   pixi run eval-episode
   ```
   - Pass `--start-role hider` to have Agent1 begin as the hider.
   - Use `--duration <seconds>` if you need a longer window (default: 15s).
   - Override the output path or plot title with `--output` and `--title`.
2. Re-plot an existing trajectory JSONL at any time:
   ```bash
   pixi run plot-paths -- --trajectory data/trajectories/ep_00042.jsonl --output charts/custom_paths.png
   ```
   Omitting `--trajectory` plots the most recent file from `data/trajectories`. Legacy `app_userdata` locations are still searched as a fallback.

## Tips
- For reproducible replays, pin the same commit and policy weights used during the run.
- Set `AI_RENDER_QUALITY` (`high`/`low`) and `AI_RECORD_FPS` before launching to tweak visual fidelity and cadence.
